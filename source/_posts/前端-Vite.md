---
title: Vite
date: 2020-6-20
tags: 前端
author: 映雪
---

谁都不会忘记谁、所谓的忘记只是心里那个人被取代了。

<!--more-->

### Vite

- Vite 是构建工具，高阶封装，Vite的官方定位是下一代前端开发和构建工具。

### Vite 由来

- 实际开发中，我们在编写的代码往往是不能被浏览器直接识别的，比如ES6，TypeScript,Vue文件等。所以此时我们必须通过构建工具来对代码进行转换，编译，类似的工具有webpack,rollup,parcel.但是随着项目越来越大，需要处理的javascript呈指数级增长，模块越来越多。构建工具需要很长时间才能开启服务器，HMR也需要几秒钟才能在浏览器反应过来。所以出现了Vite。

- Vite作为一个基于浏览器原生ESM的构建工具，它省略了开发环境的打包过程，利用浏览器去解析imports，在服务端按需编译返回。同时，在开发环境拥有速度快到惊人的模块热更新，且热更新的速度不会随着模块增多而变慢。因此，使用Vite进行开发，至少会比Webpack快10倍左右。

### Vite 组成

1. dev server：利用浏览器的ESM能力来提供源文件，具有丰富的内置功能并具有高效的HMR
2. 生产构建：生产环境利用Rollup来构建代码，提供指令用来优化构建过程

### Vite 特性

1. Instant Server Start —— 即时服务启动
2. Lightning Fast HMR —— 闪电般快速的热更新
3. Rich Features —— 丰富的功能
4. Optimized Build —— 经过优化的构建
5. Universal Plugin Interface —— 通用的Plugin接口
6. Fully Typed APIs —— 类型齐全的API


### Vite 安装

```js
npm install vite -g   //全局安装
npm install vite -D   //局部安
```

### Vite 原理

1. **ESM**

- ESM的对外接口只是一种静态定义，为编译时加载，遇到模块加载命令import，就会生成一个只读引用。等脚本真正执行时，再根据这个只读引用，到被加载的那个模块内取值。由于ESM编译时就能确定模块的依赖关系，因此能够只包含要运行的代码，可以显著减少文件体积，降低浏览器压力。

2. **esbuild**

- Vite 对 js/ts 的处理没有使用如 glup, rollup 等传统打包工具，而是使用了 esbuild。esbuild 是一个全新的js打包工具，底层使用了go，大量使用了并行操作，可以充分利用CPU资源。esbuild支持如babel, 压缩等的功能。

3. **请求拦截**

- Vite 的基本实现原理，就是启动一个 koa 服务器拦截由浏览器请求 ESM的请求。通过请求的路径找到目录下对应的文件做一定的处理最终以 ESM的格式返回给客户端。

![截屏2022-06-14 上午11.04.27.png](/images/2022/06/14/5zFQgOwR9tS6nf1.png)

4. **热更新**

- Vite 的热加载原理，其实就是在客户端与服务端建立了一个 websocket 连接，当代码被修改时，服务端发送消息通知客户端去请求修改模块的代码，完成热更新。

1. 服务端：服务端做的就是监听代码文件的改变，在合适的时机向客户端发送 websocket 信息通知客户端去请求新的模块代码。
2. 客户端：Vite 中客户端的 websocket 相关代码在处理 html 中时被写入代码中。可以看到在处理 html 时，vite/client 的相关代码已经被插入。


### Vite 和 Webpack

![截屏2022-06-14 上午11.10.19.png](/images/2022/06/14/B1rIVUYeNicSXzC.png)

### Vite 缺点

- 目前 Vite 还是使用的 es module 模块不能直接使用生产环境（兼容性问题）。默认情况下，无论是 dev 还是 build 都会直接打出 ESM 版本的代码包，这就要求客户浏览器需要有一个比较新的版本，这放在现在的国情下还是有点难度的。不过 Vite 同时提供了一些弥补的方法，使用 build.polyfillDynamicImport 配置项配合 @vitejs/plugin-legacy 打包出一个看起来兼容性比较好的版本。
- 生产环境使用 rollup 打包会造成开发环境与生产环境的不一致。
- 很多 第三方 sdk 没有产出 ems 格式的的代码，这个需要自己去做一些兼容。

### 构建工具和打包工具区别

- 构建过程应该包括 预编译、语法检查、词法检查、依赖处理、文件合并、文件压缩、单元测试、版本管理等 。
- 打包工具更注重打包这一过程，主要包括依赖管理和版本管理。